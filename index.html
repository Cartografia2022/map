<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Editor GeoJSON con Leaflet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-measure/dist/leaflet-measure.css" />
  <style>
    #map { height: 100vh; }
    .controls {
      position: absolute;
      bottom: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      font-family: sans-serif;
    }
    .controls select, .controls input, .controls button {
      margin-top: 5px;
      display: block;
      width: 100%;
    }
    #modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 2000;
    }
    #modal-content {
      background: white;
      width: 300px;
      margin: 100px auto;
      padding: 20px;
      border-radius: 10px;
      font-family: sans-serif;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    #modal select, #modal button, #modal textarea, #modal input {
      margin-top: 10px;
      width: 100%;
    }
    input[readonly] {
      background: #f0f0f0;
      cursor: not-allowed;
      color: #555;
    }
    .streetview-btn {
      display: inline-block;
      padding: 6px 12px;
      margin-top: 5px;
      background-color: #f1c40f;
      color: black !important;
      border: none;
      border-radius: 6px;
      text-align: center;
      text-decoration: none !important;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .streetview-btn:hover {
      background-color: #d4ac0d;
    }
  </style>
</head>
<body>
<div id="map"></div>

<div class="controls">
  <input type="file" id="upload" accept=".geojson" />
  <button onclick="downloadGeoJSON()">Exportar GeoJSON</button>
</div>

<div id="modal">
  <div id="modal-content">
    <label for="modal-select">Selecciona un nombre:</label>
    <select id="modal-select"></select>
    
    <label for="modal-tipo">Tipo:</label>
    <input type="text" id="modal-tipo" readonly>

    <label for="modal-desc">Descripción (opcional):</label>
    <textarea id="modal-desc" rows="3" placeholder="Escribe una descripción..."></textarea>
    <button id="modal-confirm">Confirmar</button>
    <button id="modal-cancel">Cancelar</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/leaflet-measure/dist/leaflet-measure.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<script>
  // ✅ Diccionario sin claves repetidas
  const categorias = {
    "ALCALDIA": "INSTITUCION",
    "BOMBEROS": "INSTITUCION",
    "CAMARA DE COMERCIO": "INSTITUCION",
    "COMISARIA DE FAMILIA": "INSTITUCION",
    "CONTRALORIA": "INSTITUCION",
    "CRUZ ROJA": "INSTITUCION",
    "DEFENSA CIVIL": "INSTITUCION",
    "DEFENSORIA DEL PUEBLO": "INSTITUCION",
    "DIAN": "INSTITUCION",
    "EMPRESA MUNICIPAL": "INSTITUCION",
    "EMPRESA PRIVADA": "INSTITUCION",
    "ENTIDAD FINANCIERA": "INSTITUCION",
    "ENTIDAD ECLESIASTICA": "INSTITUCION",
    "ENTIDADES DE SALUD": "INSTITUCION",
    "ENTIDADES EDUCATIVA": "INSTITUCION",
    "FISCALIA": "INSTITUCION",
    "GOBERNACION": "INSTITUCION",
    "ICBF": "INSTITUCION",
    "INSPECCION DE POLICIA": "INSTITUCION",
    "JUZGADO": "INSTITUCION",
    "MINISTERIO": "INSTITUCION",
    "NOTARIA": "INSTITUCION",
    "PERSONERIA": "INSTITUCION",
    "PROCURADURIA": "INSTITUCION",
    "REGISTRADURIA": "INSTITUCION",
    "TELECOMUNICACIONES": "INSTITUCION",

    "ACUEDUCTO": "SITIO",
    "AEROPUERTO": "SITIO",
    "ALCANTARILLA": "SITIO",
    "ANCIANATO": "SITIO",
    "ANTENA": "SITIO",
    "CANCHA": "SITIO",
    "CANTERA": "SITIO",
    "CAÑO": "SITIO",
    "CARCEL": "SITIO",
    "CASA DEL ALCALDE": "SITIO",
    "CEMENTERIO": "SITIO",
    "CERRO": "SITIO",
    "COLISEO": "SITIO",
    "CRUCE": "SITIO",
    "ESTABLECIMIENTO PÚBLICO": "SITIO",
    "ESTACIÓN DE FERROCARRIL": "SITIO",
    "ESTACIÓN DE GASOLINA": "SITIO",
    "ESTADIO": "SITIO",
    "GASODUCTO": "SITIO",
    "HELIPUERTO": "SITIO",
    "LAGUNA": "SITIO",
    "MATADERO": "SITIO",
    "MUELLE": "SITIO",
    "OLEODUCTO": "SITIO",
    "PARQUE": "SITIO",
    "PARQUEADERO": "SITIO",
    "PEAJE": "SITIO",
    "PISTA DE ATERRIZAJE": "SITIO",
    "PLAZA DE MERCADO": "SITIO",
    "PLAZA DE TOROS": "SITIO",
    "POLIDEPORTIVO": "SITIO"
  };

  const map = L.map('map').setView([5.5, -73.4], 9);
  const drawnItems = new L.FeatureGroup();
  const labelLayer = new L.LayerGroup();
  const layerTooltips = new Map();

  L.Control.geocoder({ defaultMarkGeocode: false })
    .on('markgeocode', e => map.fitBounds(e.geocode.bbox)).addTo(map);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  map.addLayer(drawnItems);
  map.addLayer(labelLayer);

  const drawControl = new L.Control.Draw({
    edit: { featureGroup: drawnItems },
    draw: { polygon: true, polyline: true, rectangle: false, circle: false, marker: true }
  });
  map.addControl(drawControl);

  function createTooltip(nombre, layer) {
    const tooltip = L.tooltip({ permanent: true, direction: 'top', offset: [0, -10] })
      .setContent(nombre)
      .setLatLng(layer.getLatLng ? layer.getLatLng() : layer.getBounds().getCenter());
    labelLayer.addLayer(tooltip);
    layerTooltips.set(layer._leaflet_id, tooltip);
  }

  function mostrarModal(opciones, nombreActual, descActual = "") {
    const modal = document.getElementById('modal');
    const selectModal = document.getElementById('modal-select');
    const descModal = document.getElementById('modal-desc');
    const tipoInput = document.getElementById('modal-tipo');
    selectModal.innerHTML = '';

    opciones.forEach(opt => {
      const option = document.createElement('option');
      option.value = opt;
      option.textContent = opt;
      if (opt === nombreActual) option.selected = true;
      selectModal.appendChild(option);
    });

    function actualizarTipo() {
      const nombreSel = selectModal.value;
      tipoInput.value = categorias[nombreSel] || "OTRO";
    }
    selectModal.onchange = actualizarTipo;
    actualizarTipo();

    descModal.value = descActual || "";

    return new Promise(resolve => {
      modal.style.display = 'block';
      document.getElementById('modal-confirm').onclick = () => {
        modal.style.display = 'none';
        resolve({ nombre: selectModal.value, descripcion: descModal.value, tipo: tipoInput.value });
      };
      document.getElementById('modal-cancel').onclick = () => {
        modal.style.display = 'none';
        resolve(null);
      };
    });
  }

  map.on(L.Draw.Event.CREATED, async function (e) {
    const layer = e.layer;
    const opciones = Object.keys(categorias);
    const respuesta = await mostrarModal(opciones, opciones[0]);
    if (!respuesta) return;

    layer.feature = { type: "Feature", properties: { 
      nombre: respuesta.nombre, 
      descripcion: respuesta.descripcion, 
      tipo: respuesta.tipo 
    }};

    let popupContent = `<strong>Nombre:</strong> ${respuesta.nombre}<br/>`;
    popupContent += `<strong>Tipo:</strong> ${respuesta.tipo}<br/>`;
    if (respuesta.descripcion.trim()) popupContent += `<strong>Descripción:</strong> ${respuesta.descripcion}<br/>`;

    layer.bindPopup(popupContent);
    drawnItems.addLayer(layer);
    createTooltip(respuesta.nombre, layer);
  });
</script>
</body>
</html>
