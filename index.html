<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Editor GeoJSON con Leaflet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-measure/dist/leaflet-measure.css" />
  <style>
    #map { height: 100vh; }
    .controls { position: absolute; bottom: 10px; left: 10px; z-index:1000; background:white; padding:10px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.3); font-family:sans-serif; }
    .controls select, .controls input, .controls button { margin-top:5px; display:block; width:100%; }
    #modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color: rgba(0,0,0,0.5); z-index:2000; }
    #modal-content { background:white; width:320px; max-width: calc(100% - 24px); margin:80px auto; padding:20px; border-radius:10px; font-family:sans-serif; box-shadow:0 0 10px rgba(0,0,0,0.3); }
    #modal label { font-size:13px; color:#333; }
    #modal select, #modal button, #modal textarea, #modal input { margin-top:8px; width:100%; box-sizing:border-box; }
    .streetview-btn { display:inline-block; padding:6px 12px; margin-top:5px; background-color:#f1c40f; color:black !important; border:none; border-radius:6px; text-align:center; text-decoration:none !important; font-size:14px; cursor:pointer; transition:background-color 0.3s ease; }
    .streetview-btn:hover { background-color:#d4ac0d; }
    #modal-desc {
    text-transform: uppercase;
}
  </style>
</head>
<body>
<div id="map"></div>

<div class="controls">
  <input type="file" id="upload" accept=".geojson" />
  <button onclick="downloadGeoJSON()">Exportar GeoJSON</button>
</div>

<div id="modal">
  <div id="modal-content">
    <label for="modal-select">Selecciona Sito/Institución :</label>
    <select id="modal-select"></select>

    <label for="modal-tipo">Tipo:</label>
    <input id="modal-tipo" type="text" readonly />

    <label for="modal-desc">Dirección:</label>
    <textarea id="modal-desc" rows="3" placeholder="Escribe una dirección..."></textarea>

    <button id="modal-confirm">Confirmar</button>
    <button id="modal-cancel">Cancelar</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/leaflet-measure/dist/leaflet-measure.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<script>
const map = L.map('map').setView([5.5, -73.4], 9);
const drawnItems = new L.FeatureGroup();
const labelLayer = new L.LayerGroup();
const layerTooltips = new Map();

// Contadores
let siteCounter = 1;      // Sitios: 1,2,3...
let instCounter = 0;      // Instituciones: A,B,C...

// Opciones NOMBRE + TIPO

const opcionesConTipo = [
  { nombre: "ACUEDUCTO", tipo: "SITIO" },
  { nombre: "AEROGENERADOR", tipo: "SITIO" },
  { nombre: "AEROPUERTO", tipo: "SITIO" },
  { nombre: "ALCALDIA", tipo: "INSTITUCION" },
  { nombre: "ALCANTARILLA", tipo: "SITIO" },
  { nombre: "ANCIANATO", tipo: "SITIO" },
  { nombre: "ANTENA", tipo: "SITIO" },
  { nombre: "ANTENA DE TELECOMUNICACIONES", tipo: "SITIO" },
  { nombre: "ARSENAL", tipo: "SITIO" },
  { nombre: "ASAMBLEA LEGISLATIVA", tipo: "INSTITUCION" },
  { nombre: "AUTOPISTA", tipo: "SITIO" },
  { nombre: "BANCO", tipo: "INSTITUCION" },
  { nombre: "BASE MILITAR", tipo: "SITIO" },
  { nombre: "BIBLIOTECA PUBLICA", tipo: "INSTITUCION" },
  { nombre: "BOMBEROS", tipo: "INSTITUCION" },
  { nombre: "CABINA DE CONTROL ELECTRICO", tipo: "SITIO" },
  { nombre: "CAMARA DE COMERCIO", tipo: "INSTITUCION" },
  { nombre: "CANAL DE TELEVISION", tipo: "INSTITUCION" },
  { nombre: "CANCHA", tipo: "SITIO" },
  { nombre: "CANTERA", tipo: "SITIO" },
  { nombre: "CAÑO", tipo: "SITIO" },
  { nombre: "CARCEL", tipo: "SITIO" },
  { nombre: "CARCEL MUNICIPAL", tipo: "INSTITUCION" },
  { nombre: "CASA CURAL", tipo: "SITIO" },
  { nombre: "CASA DEL ALCALDE", tipo: "SITIO" },
  { nombre: "CEMENTERIO", tipo: "SITIO" },
  { nombre: "CENTRAL HIDROELECTRICA", tipo: "SITIO" },
  { nombre: "CENTRO COMERCIAL", tipo: "SITIO" },
  { nombre: "CENTRO DE COMUNICACIONES", tipo: "SITIO" },
  { nombre: "CENTRO DE DISTRIBUCION", tipo: "SITIO" },
  { nombre: "CERRO", tipo: "SITIO" },
  { nombre: "CLINICA", tipo: "INSTITUCION" },
  { nombre: "COLEGIO", tipo: "INSTITUCION" },
  { nombre: "COLINA", tipo: "SITIO" },
  { nombre: "COLISEO", tipo: "SITIO" },
  { nombre: "COMISARIA DE FAMILIA", tipo: "INSTITUCION" },
  { nombre: "CONCENTRACION SUBERSIVA", tipo: "SITIO" },
  { nombre: "CONGRESO", tipo: "INSTITUCION" },
  { nombre: "CONTRALORIA", tipo: "INSTITUCION" },
  { nombre: "CORREDOR VIAL ESTRATEGICO", tipo: "SITIO" },
  { nombre: "CRUCE", tipo: "SITIO" },
  { nombre: "CRUZ ROJA", tipo: "INSTITUCION" },
  { nombre: "DEFENSA CIVIL", tipo: "INSTITUCION" },
  { nombre: "DEFENSORIA DEL PUEBLO", tipo: "INSTITUCION" },
  { nombre: "DEPOSITO DE COMBUSTIBLE", tipo: "SITIO" },
  { nombre: "DIAN", tipo: "INSTITUCION" },
  { nombre: "EDIFICIO GUBERNAMENTAL", tipo: "SITIO" },
  { nombre: "EMBALSE", tipo: "SITIO" },
  { nombre: "EMISORA DE RADIO", tipo: "INSTITUCION" },
  { nombre: "EMPRESA MUNICIPAL", tipo: "INSTITUCION" },
  { nombre: "EMPRESA PRIVADA", tipo: "INSTITUCION" },
  { nombre: "ENTIDAD ECLESIASTICA", tipo: "INSTITUCION" },
  { nombre: "ENTIDAD FINANCIERA", tipo: "INSTITUCION" },
  { nombre: "ENTIDADES DE SALUD", tipo: "INSTITUCION" },
  { nombre: "ENTIDADES EDUCATIVA", tipo: "INSTITUCION" },
  { nombre: "EPS", tipo: "INSTITUCION" },
  { nombre: "ESTACION DE POLICIA", tipo: "INSTITUCION" },
  { nombre: "ESTACION DE SERVICIO", tipo: "SITIO" },
  { nombre: "ESTACION DE TREN", tipo: "SITIO" },
  { nombre: "ESTABLECIMIENTO PUBLICO", tipo: "SITIO" },
  { nombre: "ESTADIO", tipo: "SITIO" },
  { nombre: "ESTACIÓN DE FERROCARRIL", tipo: "SITIO" },
  { nombre: "ESTACIÓN DE GASOLINA", tipo: "SITIO" },
  { nombre: "FABRICA", tipo: "SITIO" },
  { nombre: "FISCALIA", tipo: "INSTITUCION" },
  { nombre: "FRONTERA", tipo: "SITIO" },
  { nombre: "GASODUCTO", tipo: "SITIO" },
  { nombre: "GOBERNACION", tipo: "INSTITUCION" },
  { nombre: "HELIPUERTO", tipo: "SITIO" },
  { nombre: "HOSPITAL", tipo: "INSTITUCION" },
  { nombre: "ICBF", tipo: "INSTITUCION" },
  { nombre: "INSTALACION DEPORTIVA", tipo: "SITIO" },
  { nombre: "INSPECCION DE POLICIA", tipo: "INSTITUCION" },
  { nombre: "JARDIN BOTANICO", tipo: "SITIO" },
  { nombre: "JUZGADO", tipo: "INSTITUCION" },
  { nombre: "LAGO", tipo: "SITIO" },
  { nombre: "LAGUNA", tipo: "SITIO" },
  { nombre: "LINEA DE TRANSMISION ELECTRICA", tipo: "SITIO" },
  { nombre: "LOTE BALDIO", tipo: "SITIO" },
  { nombre: "MALECON", tipo: "SITIO" },
  { nombre: "MALETERO", tipo: "SITIO" },
  { nombre: "MATADERO", tipo: "SITIO" },
  { nombre: "MINISTERIO", tipo: "INSTITUCION" },
  { nombre: "MIRADOR", tipo: "SITIO" },
  { nombre: "MONUMENTO", tipo: "SITIO" },
  { nombre: "MUSEO", tipo: "INSTITUCION" },
  { nombre: "MUELLE", tipo: "SITIO" },
  { nombre: "NOTARIA", tipo: "INSTITUCION" },
  { nombre: "OBRA EN CONSTRUCCION", tipo: "SITIO" },
  { nombre: "OFICINA DE CORREOS", tipo: "INSTITUCION" },
  { nombre: "OLEODUCTO", tipo: "SITIO" },
  { nombre: "OTROS", tipo: "SITIO" },
  { nombre: "PARQUE", tipo: "SITIO" },
  { nombre: "PARQUEADERO", tipo: "SITIO" },
  { nombre: "PEAJE", tipo: "SITIO" },
  { nombre: "PERSONERIA", tipo: "INSTITUCION" },
  { nombre: "PISTA DE ATERRIZAJE", tipo: "SITIO" },
  { nombre: "PLANTA DE TRATAMIENTO", tipo: "SITIO" },
  { nombre: "PLAZA DE MERCADO", tipo: "SITIO" },
  { nombre: "PLAZA DE TOROS", tipo: "SITIO" },
  { nombre: "PLAZOLETA", tipo: "SITIO" },
  { nombre: "POLIDEPORTIVO", tipo: "SITIO" },
  { nombre: "POSIBLE RAMPA DE CILINDROS", tipo: "SITIO" },
  { nombre: "POSIBLE HELIPUERTO", tipo: "SITIO" },
  { nombre: "POSIBLE UBICACION DE AMETRALLADORA", tipo: "SITIO" },
  { nombre: "POSIBLE UBICACION DE TATUCOS", tipo: "SITIO" },
  { nombre: "PRESIDENCIA", tipo: "INSTITUCION" },
  { nombre: "PROCURADURIA", tipo: "INSTITUCION" },
  { nombre: "PUENTE", tipo: "SITIO" },
  { nombre: "PUERTO", tipo: "SITIO" },
  { nombre: "PUESTO DE POLICIA", tipo: "INSTITUCION" },
  { nombre: "QUEBRADA", tipo: "SITIO" },
  { nombre: "REFINERIA", tipo: "SITIO" },
  { nombre: "REGISTRADURIA", tipo: "INSTITUCION" },
  { nombre: "REPEATADOR DE TELEVISION", tipo: "SITIO" },
  { nombre: "RIO", tipo: "SITIO" },
  { nombre: "SALIDA MUNICIPIO", tipo: "SITIO" },
  { nombre: "SECRETARIA DE TRANSITO", tipo: "INSTITUCION" },
  { nombre: "SEDE DE PARTIDO POLITICO", tipo: "INSTITUCION" },
  { nombre: "SUBESTACION DE POLICIA", tipo: "INSTITUCION" },
  { nombre: "SUBESTACION ELECTRICA", tipo: "SITIO" },
  { nombre: "TELECOMUNICACIONES", tipo: "INSTITUCION" },
  { nombre: "TERMINAL DE TRANSPORTE", tipo: "SITIO" },
  { nombre: "TORRE DE CONTROL", tipo: "SITIO" },
  { nombre: "TORRE DE ENFRIAMIENTO", tipo: "SITIO" },
  { nombre: "TUNEL", tipo: "SITIO" },
  { nombre: "UNIVERSIDAD", tipo: "INSTITUCION" },
  { nombre: "VIADUCTO", tipo: "SITIO" },
  { nombre: "ZOOLOGICO", tipo: "SITIO" }
];


// ====== BASEMAPS Y OVERLAYS ======
const baseMaps = {
  "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map),
  "Esri Satélite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'Esri'}),
};

const overlayMaps = { "Elementos Dibujados": drawnItems, "Etiquetas": labelLayer };

L.control.layers(baseMaps, overlayMaps).addTo(map);
map.addLayer(drawnItems);
map.addLayer(labelLayer);
L.control.measure({ primaryLengthUnit:'meters', secondaryLengthUnit:'kilometers' }).addTo(map);
L.Control.geocoder({defaultMarkGeocode:false}).on('markgeocode', e=>map.fitBounds(e.geocode.bbox)).addTo(map);

const drawControl = new L.Control.Draw({
  edit: { featureGroup: drawnItems },
  draw: { polygon:true, polyline:true, rectangle:false, circle:false, circlemarker:false, marker:true }
});
map.addControl(drawControl);

// ====== TOOLTIP ======
function layerCenter(layer){ return layer.getLatLng ? layer.getLatLng() : layer.getBounds().getCenter(); }

function createTooltip(nombre, layer) {
  const tooltip = L.tooltip({permanent:true,direction:'top',offset:[0,-10]}).setContent(nombre).setLatLng(layerCenter(layer));
  labelLayer.addLayer(tooltip);
  layerTooltips.set(layer._leaflet_id, tooltip);
  layer.on('move',()=>{ tooltip.setLatLng(layerCenter(layer)); });
}

function updateTooltip(layer) {
  const tooltip = layerTooltips.get(layer._leaflet_id);
  if(tooltip){ tooltip.setLatLng(layerCenter(layer)); tooltip.setContent(layer.feature?.properties?.nombre || "Sin nombre"); }
}

// ====== MODAL ======
function mostrarModalConTipo(defaultNombre, defaultTipo, descActual=""){
  const modal = document.getElementById('modal');
  const selectModal = document.getElementById('modal-select');
  const tipoInput = document.getElementById('modal-tipo');
  const descModal = document.getElementById('modal-desc');
  const botonConfirm = document.getElementById('modal-confirm');
  const botonCancel = document.getElementById('modal-cancel');

  selectModal.innerHTML = '';
  opcionesConTipo.forEach(opt=>{
    const option = document.createElement('option');
    option.value = `${opt.nombre}|${opt.tipo}`;
    option.textContent = opt.nombre;
    if(opt.nombre===defaultNombre && opt.tipo===defaultTipo) option.selected=true;
    selectModal.appendChild(option);
  });

  function actualizarTipoDesdeSelect(){
    const [n,t] = (selectModal.value||'|').split('|');
    tipoInput.value = t||'';
  }

  actualizarTipoDesdeSelect();
  selectModal.onchange = actualizarTipoDesdeSelect;
  descModal.value = descActual;

  return new Promise(resolve=>{
    modal.style.display='block';
    botonConfirm.onclick = () => {
    modal.style.display = 'none';
    const [nombre, tipo] = (selectModal.value || '|').split('|');
    resolve({
    nombre,
    tipo,
    direccion: descModal.value.toUpperCase() // <-- fuerza mayúsculas
  });
};

    botonCancel.onclick=()=>{ modal.style.display='none'; resolve(null); };
  });
}

// ====== ACTUALIZAR CONTADORES ======
function actualizarContadores(layer){
  const props = layer.feature?.properties;
  if(!props || !props.tipo || !props.orden) return;

  if(props.tipo==="SITIO"){
    const num = parseInt(props.orden);
    if(!isNaN(num) && num>=siteCounter) siteCounter=num+1;
  } else if(props.tipo==="INSTITUCION"){
    const letra = props.orden?.toUpperCase();
    if(letra){
      const code = letra.charCodeAt(0)-65;
      if(code>=instCounter) instCounter=code+1;
    }
  }
}

// ====== CREAR ELEMENTO ======
map.on(L.Draw.Event.CREATED, async function(e){
  const layer = e.layer;
  if(layer instanceof L.Polygon && turf.kinks(layer.toGeoJSON()).features.length>0){
    alert("ERROR: Polígono se cruza a sí mismo."); return;
  }

  const respuesta = await mostrarModalConTipo("ACUEDUCTO","SITIO");
  if(!respuesta) return;

  const {nombre,tipo,direccion} = respuesta;
  const props = { nombre, tipo, direccion };

  // ASIGNAR ORDEN AUTOMÁTICO
  if(tipo==="SITIO"){ props.orden = siteCounter++; }
  else if(tipo==="INSTITUCION"){ props.orden = String.fromCharCode(65+instCounter++); }

  layer.feature = { type:"Feature", properties: props };

  const center = layerCenter(layer);
  let popupContent = `<strong>Nombre:</strong>${nombre}<br/><strong>Tipo:</strong>${tipo}<br/>`;
  if(direccion?.trim()!=="") popupContent+=`<strong>Dirección:</strong>${direccion}<br/>`;
  if(layer instanceof L.Marker){
    popupContent+=`<a href="https://www.google.com/maps?q=&layer=c&cbll=${center.lat},${center.lng}" target="_blank"><div class="streetview-btn">Abrir Street View</div></a>`;
  }
  layer.bindPopup(popupContent);
  drawnItems.addLayer(layer);
  createTooltip(nombre,layer);
});

// ====== EDITAR ELEMENTO ======
map.on(L.Draw.Event.EDITED, async function(e){
  const editedLayers = e.layers;
  let initNombre="ACUEDUCTO", initTipo="SITIO", initDesc="";
  editedLayers.eachLayer(layer=>{
    initNombre = layer.feature?.properties?.nombre || initNombre;
    initTipo   = layer.feature?.properties?.tipo || initTipo;
    initDesc   = layer.feature?.properties?.direccion || "";
  });

  const respuesta = await mostrarModalConTipo(initNombre, initTipo, initDesc);
  if(!respuesta) return;

  editedLayers.eachLayer(layer=>{
    const {nombre,tipo,direccion}=respuesta;
    if(!layer.feature) layer.feature={type:"Feature",properties:{}};
    layer.feature.properties.nombre=nombre;
    layer.feature.properties.tipo=tipo;
    layer.feature.properties.direccion=direccion;

    const center = layerCenter(layer);
    let popupContent = `<strong>Nombre:</strong>${nombre}<br/><strong>Tipo:</strong>${tipo}<br/>`;
    if(direccion?.trim()!=="") popupContent+=`<strong>Dirección:</strong>${direccion}<br/>`;
    if(layer instanceof L.Marker){
      popupContent+=`<a href="https://www.google.com/maps?q=&layer=c&cbll=${center.lat},${center.lng}" target="_blank"><div class="streetview-btn">Abrir Street View</div></a>`;
    }
    layer.bindPopup(popupContent);
    updateTooltip(layer);
  });
});

// ====== ELIMINAR ELEMENTO ======
map.on(L.Draw.Event.DELETED, function(e){
  e.layers.eachLayer(layer=>{
    const tooltip = layerTooltips.get(layer._leaflet_id);
    if(tooltip){ labelLayer.removeLayer(tooltip); layerTooltips.delete(layer._leaflet_id); }
  });
});

// ====== CARGAR GEOJSON ======
document.getElementById('upload').addEventListener('change', function(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    const geojson = JSON.parse(e.target.result);
    L.geoJSON(geojson,{
      onEachFeature:function(feature, layer){
        const nombre = feature.properties?.nombre || "Sin nombre";
        const tipo = feature.properties?.tipo || "";
        const direccion = feature.properties?.direccion || "";
        layer.feature = feature;

        // actualizar contadores según archivo cargado
        actualizarContadores(layer);

        const center = layerCenter(layer);
        let popupContent = `<strong>Nombre:</strong>${nombre}<br/>`;
        if(tipo) popupContent+=`<strong>Tipo:</strong>${tipo}<br/>`;
        if(direccion?.trim()!=="") popupContent+=`<strong>Dirección:</strong>${direccion}<br/>`;
        if(layer instanceof L.Marker){
          popupContent+=`<a href="https://www.google.com/maps?q=&layer=c&cbll=${center.lat},${center.lng}" target="_blank"><div class="streetview-btn">Abrir Street View</div></a>`;
        }

        layer.bindPopup(popupContent);
        drawnItems.addLayer(layer);
        createTooltip(nombre,layer);
      }
    });
  };
  reader.readAsText(file);
});

// ====== EXPORTAR GEOJSON ======
function downloadGeoJSON(){
  const data = drawnItems.toGeoJSON();
  if(!data.features.length){ alert("No hay elementos para exportar."); return; }

  // agregar orden a cada feature antes de descargar
  data.features.forEach(f=>{
    if(!f.properties) f.properties={};
    // ya tiene f.properties.orden asignado
  });

  const blob = new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "mapa.geojson";
  a.click();
  URL.revokeObjectURL(url);
}
window.downloadGeoJSON = downloadGeoJSON;

  // ====== CAPA MUNICIPIOS (OPCIONAL) ======
  fetch('Municipios.geojson')
    .then(res => res.json())
    .then(data => {
      const capaBoyaca = L.geoJSON(data, {
        style: { color: '#000000', weight: 2, fillOpacity: 0 }
      });
      capaBoyaca.addTo(map);
      overlayMaps["Municipios"] = capaBoyaca;
    })
    .catch(()=>{ /* silencioso si no existe */ });

</script>
</body>
</html>



